{
  "implementation_research": {
    "approaches": [
      {
        "provider": "Hyper-V",
        "type": "Primary Recommendation",
        "pros": [
          "Free with Windows Pro/Enterprise (no additional licensing cost)",
          "Native PowerShell integration with comprehensive cmdlet coverage",
          "PowerShell Direct enables command execution without network connectivity (via VM bus)",
          "Copy-VMFile cmdlet provides native file transfer capability",
          "Excellent snapshot/checkpoint support for backup/restore workflows",
          "High performance with native hypervisor integration",
          "Microsoft-supported with regular security updates"
        ],
        "cons": [
          "Requires Windows Pro or Enterprise (not available on Home editions)",
          "Cannot run on systems with other hypervisors simultaneously (Type 1 hypervisor)",
          "Less cross-platform VM portability than VirtualBox",
          "VM configuration stored in binary format (less script-friendly than VMX files)"
        ],
        "cli_tools": [
          "PowerShell Module: Hyper-V (Get-VM, Start-VM, Stop-VM, Checkpoint-VM)",
          "PowerShell Direct: Invoke-Command -VMName -FilePath",
          "File Transfer: Copy-VMFile -SourcePath -DestinationPath"
        ],
        "automation_suitability": "Excellent - PowerShell is the gold standard for Windows automation"
      },
      {
        "provider": "VirtualBox",
        "type": "Fallback Recommendation",
        "pros": [
          "Completely free and open source (GPL v2)",
          "Cross-platform host support (Windows, Linux, macOS)",
          "VBoxManage CLI is comprehensive and well-documented",
          "VM configuration in XML (human-readable, script-friendly)",
          "Large community with extensive documentation",
          "Can run alongside Hyper-V with newer versions (Windows 11+)",
          "Supports more guest OS types than Hyper-V"
        ],
        "cons": [
          "Guest Additions required for advanced features (shared folders, seamless mode)",
          "Guest control requires Guest Additions installation",
          "Performance generally lower than Hyper-V for Windows guests",
          "File transfer requires shared folders or guest control (no native equivalent to Copy-VMFile)"
        ],
        "cli_tools": [
          "VBoxManage list vms --long",
          "VBoxManage startvm --type headless",
          "VBoxManage controlvm poweroff",
          "VBoxManage guestcontrol execute/run",
          "VBoxManage snapshot take/restore"
        ],
        "automation_suitability": "Very Good - VBoxManage provides complete control via CLI"
      },
      {
        "provider": "VMware Workstation Pro",
        "type": "Alternative (Paid)",
        "pros": [
          "vmrun CLI included with license",
          "Excellent Unity mode for seamless integration",
          "Industry-standard VM format (broad compatibility)",
          "Robust snapshot and cloning capabilities",
          "vmrun runProgramInGuest for command execution",
          "vmrun copyFileFromHostToGuest for file transfer"
        ],
        "cons": [
          "~$200 per license (significant cost for multi-VM deployments)",
          "No native PowerShell module (requires vmrun wrapper)",
          "Less suitable for automation-heavy workflows compared to Hyper-V PowerShell",
          "VMware ecosystem lock-in"
        ],
        "cli_tools": [
          "vmrun list",
          "vmrun start/stop/reset",
          "vmrun runProgramInGuest",
          "vmrun copyFileFromHostToGuest/copyFileFromGuestToHost",
          "vmrun snapshot/revertToSnapshot"
        ],
        "automation_suitability": "Good - vmrun is capable but less integrated than PowerShell"
      }
    ],
    "recommended": "Hyper-V as primary provider with VirtualBox as fallback",
    "rationale": "Hyper-V is the optimal choice for P4NTH30N's Windows-centric automation environment due to: (1) Zero additional cost for Windows Pro environments, (2) PowerShell Direct eliminates network dependency for command execution - critical for pre-network VM configuration, (3) Native Copy-VMFile provides reliable file transfer without requiring guest agent installation, (4) Deep integration with Windows security and management tools, (5) Checkpoints provide instant rollback capability for testing deployments. VirtualBox serves as an excellent fallback for: (1) Development environments on Windows Home, (2) Cross-platform compatibility requirements, (3) Running alongside Hyper-V on Windows 11 systems, (4) Access to specific guest OS types not well-supported by Hyper-V. The Strategy pattern implementation allows seamless provider switching without code changes."
  },
  "architecture_design": {
    "components": [
      "IVMProvider - Strategy interface for VM operations (start, stop, status, execute, snapshot)",
      "HyperVProvider - PowerShell-based Hyper-V implementation",
      "VirtualBoxProvider - VBoxManage-based VirtualBox implementation",
      "IVMFileTransfer - Interface for file transfer operations",
      "HyperVFileTransfer - PowerShell Copy-VMFile implementation",
      "VirtualBoxFileTransfer - Guest control file transfer implementation",
      "IFtpClient - Interface for FTP/SFTP operations",
      "FluentFtpClient - FluentFTP implementation for FTP/FTPS",
      "SshNetFtpClient - SSH.NET implementation for SFTP",
      "VMDeploymentService - High-level orchestration service",
      "VMDeploymentQueue - Queue-based deployment for multiple VMs",
      "VMHealthMonitor - Status monitoring and health checking",
      "VMConfiguration - Configuration models for VM settings",
      "VMDeploymentResult - Result types for deployment operations"
    ],
    "data_flow": "VMDeploymentService receives deployment requests → Validates configuration → Selects appropriate IVMProvider via factory → Executes VM lifecycle operations (start/ensure running) → Performs file transfers via IFtpClient or IVMFileTransfer → Executes deployment commands via IVMProvider → Monitors health via VMHealthMonitor → Returns VMDeploymentResult. The queue-based deployment system batches multiple VM requests and processes them with configurable parallelism. All operations are async with proper cancellation token support. Error handling follows P4NTH30N patterns with line number logging.",
    "integration_points": [
      "Interfaces defined in C0MMON/Interfaces/ following existing IRepoCredentials, IReceiveSignals patterns",
      "Implementations placed in C0MMON/Infrastructure/Deployment/ alongside existing persistence infrastructure",
      "Uses existing IStoreErrors interface for error logging to ERR0R collection",
      "Integrates with existing logging patterns via ILogger or direct console output with line numbers",
      "Async/await throughout matching H4ND and H0UND agent patterns",
      "Configuration via existing config mechanisms (MongoDB or appsettings)",
      "VMDeploymentService can be injected into H4ND for automated deployment workflows",
      "Health monitoring can write to existing MongoDB collections",
      "Follows nullable reference types pattern with proper null checking",
      "Uses Result<T> pattern for operation outcomes where appropriate"
    ]
  },
  "build_guide": {
    "phases": [
      {
        "phase": "Phase 1: Core Interfaces and Abstractions",
        "steps": [
          "Create IVMProvider interface with StartVM, StopVM, GetVMStatus, ExecuteCommand, CreateSnapshot, RestoreSnapshot methods",
          "Create IVMFileTransfer interface with UploadFile, DownloadFile, UploadDirectory, DownloadDirectory methods",
          "Create IFtpClient interface with Connect, Disconnect, Upload, Download, ListDirectory, Delete methods",
          "Define VMConfiguration record with Name, ProviderType, MemoryMB, CpuCount, NetworkAdapter settings",
          "Define VMStatus enum (Stopped, Starting, Running, Paused, Saved, Unknown)",
          "Define VMDeploymentResult record with Success, Message, VMName, Duration properties",
          "Create VMProviderType enum (HyperV, VirtualBox, VMware)",
          "Define DeploymentOptions record with Timeout, RetryCount, ParallelExecution settings",
          "Place all interfaces in C0MMON/Interfaces/ with P4NTH30N.C0MMON.Interfaces namespace",
          "Define models in C0MMON/Support/Deployment/ namespace"
        ]
      },
      {
        "phase": "Phase 2: Hyper-V Implementation",
        "steps": [
          "Create HyperVProvider class implementing IVMProvider",
          "Implement PowerShell command execution via Process.Start with runspace",
          "Implement StartVM using 'Start-VM -Name {name} -Passthru'",
          "Implement StopVM with graceful (Shutdown-VMGuest) and force (Stop-VM) options",
          "Implement GetVMStatus parsing (Get-VM | Select-Object State)",
          "Implement ExecuteCommand using Invoke-Command -VMName for PowerShell Direct",
          "Implement CreateSnapshot using Checkpoint-VM -SnapshotName",
          "Implement RestoreSnapshot using Restore-VMSnapshot -Name",
          "Create HyperVFileTransfer implementing IVMFileTransfer with Copy-VMFile",
          "Add PowerShell error parsing and exception translation",
          "Implement line number logging following existing error handling pattern"
        ]
      },
      {
        "phase": "Phase 3: VirtualBox Implementation",
        "steps": [
          "Create VirtualBoxProvider class implementing IVMProvider",
          "Implement VBoxManage command builder and execution",
          "Implement StartVM using 'VBoxManage startvm {name} --type headless'",
          "Implement StopVM with ACPI shutdown and poweroff options",
          "Implement GetVMStatus parsing 'VBoxManage showvminfo {name} --machinereadable'",
          "Implement ExecuteCommand using VBoxManage guestcontrol run",
          "Implement snapshot operations via VBoxManage snapshot",
          "Create VirtualBoxFileTransfer implementing IVMFileTransfer with guestcontrol copyto/copyfrom",
          "Handle Guest Additions availability detection",
          "Implement proper error handling for VBoxManage exit codes"
        ]
      },
      {
        "phase": "Phase 4: FTP/SFTP Implementation",
        "steps": [
          "Create FluentFtpClient implementing IFtpClient using FluentFTP library",
          "Implement Connect with FTPS support (explicit/implicit)",
          "Implement Upload/Download with progress reporting",
          "Implement directory operations (ListDirectory, CreateDirectory, DeleteDirectory)",
          "Create SshNetFtpClient implementing IFtpClient using SSH.NET",
          "Implement SFTP connect with key-based and password authentication",
          "Implement Upload/Download with SSH.NET SftpClient",
          "Add connection pooling for high-throughput scenarios",
          "Implement retry logic with exponential backoff",
          "Add transfer validation via checksum verification"
        ]
      },
      {
        "phase": "Phase 5: Orchestration Services",
        "steps": [
          "Create VMProviderFactory with CreateProvider(VMProviderType) method",
          "Create VMDeploymentService with DeployAsync method",
          "Implement deployment workflow: Validate → Start VM → Transfer Files → Execute Commands → Verify",
          "Create VMDeploymentQueue for batch deployment processing",
          "Implement parallel deployment with configurable degree of parallelism",
          "Create VMHealthMonitor with periodic status checking",
          "Implement VM provisioning from templates/snapshots",
          "Add deployment rollback on failure (restore snapshot)",
          "Create deployment event logging to EV3NT collection",
          "Add cancellation token support throughout"
        ]
      },
      {
        "phase": "Phase 6: Integration and Testing",
        "steps": [
          "Create extension methods for IServiceCollection registration",
          "Add configuration binding from appsettings.json or MongoDB",
          "Implement integration tests with actual Hyper-V/VirtualBox (if available)",
          "Create mock implementations for unit testing",
          "Add example usage in documentation",
          "Create PowerShell validation scripts for environment setup",
          "Test error handling and line number logging",
          "Verify async/await patterns and cancellation support",
          "Performance test parallel deployment scenarios",
          "Security review for credential handling in FTP clients"
        ]
      }
    ],
    "parallelization": [
      "Phase 1 (Interfaces) can proceed independently of all other phases",
      "Phase 2 (Hyper-V) and Phase 3 (VirtualBox) can be developed in parallel once Phase 1 is complete",
      "Phase 4 (FTP) can be developed in parallel with VM provider implementations",
      "Phase 5 (Orchestration) requires completion of Phases 1-4",
      "Phase 6 (Integration) requires all previous phases and should be sequential"
    ]
  },
  "technical_specifications": {
    "files": [
      "C0MMON/Interfaces/IVMProvider.cs - VM provider strategy interface",
      "C0MMON/Interfaces/IVMFileTransfer.cs - File transfer interface",
      "C0MMON/Interfaces/IFtpClient.cs - FTP/SFTP client interface",
      "C0MMON/Interfaces/IVMProviderFactory.cs - Factory interface",
      "C0MMON/Interfaces/IVMDeploymentService.cs - Orchestration service interface",
      "C0MMON/Support/Deployment/VMConfiguration.cs - Configuration models",
      "C0MMON/Support/Deployment/VMEnums.cs - Status and provider type enums",
      "C0MMON/Support/Deployment/VMDeploymentModels.cs - Result and options records",
      "C0MMON/Support/Deployment/FtpConfiguration.cs - FTP connection settings",
      "C0MMON/Infrastructure/Deployment/HyperVProvider.cs - Hyper-V implementation",
      "C0MMON/Infrastructure/Deployment/HyperVFileTransfer.cs - Hyper-V file transfer",
      "C0MMON/Infrastructure/Deployment/PowerShellExecutor.cs - PowerShell execution helper",
      "C0MMON/Infrastructure/Deployment/VirtualBoxProvider.cs - VirtualBox implementation",
      "C0MMON/Infrastructure/Deployment/VirtualBoxFileTransfer.cs - VirtualBox file transfer",
      "C0MMON/Infrastructure/Deployment/VBoxManageExecutor.cs - VBoxManage execution helper",
      "C0MMON/Infrastructure/Deployment/FluentFtpClient.cs - FluentFTP implementation",
      "C0MMON/Infrastructure/Deployment/SshNetFtpClient.cs - SSH.NET SFTP implementation",
      "C0MMON/Infrastructure/Deployment/VMProviderFactory.cs - Provider factory",
      "C0MMON/Services/VMDeploymentService.cs - Main orchestration service",
      "C0MMON/Services/VMDeploymentQueue.cs - Queue-based batch deployment",
      "C0MMON/Services/VMHealthMonitor.cs - Health monitoring service",
      "C0MMON/Infrastructure/Deployment/DeploymentServiceExtensions.cs - DI registration"
    ],
    "interfaces": [
      "public interface IVMProvider",
      "{",
      "    VMProviderType ProviderType { get; }",
      "    Task<bool> StartVMAsync(string vmName, CancellationToken cancellationToken = default);",
      "    Task<bool> StopVMAsync(string vmName, bool force = false, CancellationToken cancellationToken = default);",
      "    Task<VMStatus> GetVMStatusAsync(string vmName, CancellationToken cancellationToken = default);",
      "    Task<VMExecuteResult> ExecuteCommandAsync(string vmName, string command, string? workingDirectory = null, TimeSpan? timeout = null, CancellationToken cancellationToken = default);",
      "    Task<bool> CreateSnapshotAsync(string vmName, string snapshotName, string? description = null, CancellationToken cancellationToken = default);",
      "    Task<bool> RestoreSnapshotAsync(string vmName, string snapshotName, CancellationToken cancellationToken = default);",
      "    Task<IReadOnlyList<VMSnapshot>> ListSnapshotsAsync(string vmName, CancellationToken cancellationToken = default);",
      "    Task<bool> DeleteSnapshotAsync(string vmName, string snapshotName, CancellationToken cancellationToken = default);",
      "}",
      "",
      "public interface IVMFileTransfer",
      "{",
      "    Task<bool> UploadFileAsync(string vmName, string sourcePath, string destinationPath, CancellationToken cancellationToken = default);",
      "    Task<bool> DownloadFileAsync(string vmName, string sourcePath, string destinationPath, CancellationToken cancellationToken = default);",
      "    Task<bool> UploadDirectoryAsync(string vmName, string sourceDirectory, string destinationDirectory, CancellationToken cancellationToken = default);",
      "    Task<bool> DownloadDirectoryAsync(string vmName, string sourceDirectory, string destinationDirectory, CancellationToken cancellationToken = default);",
      "    Task<bool> DeleteFileAsync(string vmName, string filePath, CancellationToken cancellationToken = default);",
      "    Task<bool> DirectoryExistsAsync(string vmName, string directoryPath, CancellationToken cancellationToken = default);",
      "    Task<bool> CreateDirectoryAsync(string vmName, string directoryPath, CancellationToken cancellationToken = default);",
      "}",
      "",
      "public interface IFtpClient",
      "{",
      "    bool IsConnected { get; }",
      "    Task<bool> ConnectAsync(CancellationToken cancellationToken = default);",
      "    Task DisconnectAsync(CancellationToken cancellationToken = default);",
      "    Task<bool> UploadFileAsync(string localPath, string remotePath, CancellationToken cancellationToken = default);",
      "    Task<bool> DownloadFileAsync(string remotePath, string localPath, CancellationToken cancellationToken = default);",
      "    Task<bool> UploadDirectoryAsync(string localDirectory, string remoteDirectory, CancellationToken cancellationToken = default);",
      "    Task<bool> DownloadDirectoryAsync(string remoteDirectory, string localDirectory, CancellationToken cancellationToken = default);",
      "    Task<IReadOnlyList<FtpFileInfo>> ListDirectoryAsync(string remotePath, CancellationToken cancellationToken = default);",
      "    Task<bool> DeleteFileAsync(string remotePath, CancellationToken cancellationToken = default);",
      "    Task<bool> DeleteDirectoryAsync(string remotePath, CancellationToken cancellationToken = default);",
      "    Task<bool> CreateDirectoryAsync(string remotePath, CancellationToken cancellationToken = default);",
      "    Task<bool> DirectoryExistsAsync(string remotePath, CancellationToken cancellationToken = default);",
      "    Task<bool> FileExistsAsync(string remotePath, CancellationToken cancellationToken = default);",
      "}",
      "",
      "public interface IVMProviderFactory",
      "{",
      "    IVMProvider CreateProvider(VMProviderType providerType);",
      "    IVMFileTransfer CreateFileTransfer(VMProviderType providerType);",
      "    IReadOnlyList<VMProviderType> SupportedProviders { get; }",
      "}",
      "",
      "public interface IVMDeploymentService",
      "{",
      "    Task<VMDeploymentResult> DeployAsync(VMConfiguration configuration, DeploymentOptions? options = null, CancellationToken cancellationToken = default);",
      "    Task<IReadOnlyList<VMDeploymentResult>> DeployBatchAsync(IEnumerable<VMConfiguration> configurations, DeploymentOptions? options = null, CancellationToken cancellationToken = default);",
      "    Task<bool> UndeployAsync(string vmName, VMProviderType providerType, bool deleteSnapshots = false, CancellationToken cancellationToken = default);",
      "    Task<VMStatus> GetStatusAsync(string vmName, VMProviderType providerType, CancellationToken cancellationToken = default);",
      "}",
      "",
      "public interface IVMHealthMonitor",
      "{",
      "    Task<VMHealthStatus> CheckHealthAsync(string vmName, VMProviderType providerType, CancellationToken cancellationToken = default);",
      "    IAsyncEnumerable<VMHealthStatus> MonitorContinuouslyAsync(string vmName, VMProviderType providerType, TimeSpan interval, CancellationToken cancellationToken = default);",
      "    event EventHandler<VMHealthChangedEventArgs>? HealthChanged;",
      "}"
    ],
    "classes": [
      {
        "name": "HyperVProvider",
        "responsibilities": [
          "Execute PowerShell commands to control Hyper-V VMs",
          "Parse PowerShell output into typed VM status",
          "Handle PowerShell Direct for guest command execution",
          "Manage Hyper-V snapshots (checkpoints)",
          "Translate PowerShell errors into domain exceptions"
        ],
        "key_methods": [
          "StartVMAsync - Uses Start-VM cmdlet",
          "ExecuteCommandAsync - Uses Invoke-Command -VMName",
          "GetVMStatusAsync - Parses Get-VM State property"
        ]
      },
      {
        "name": "HyperVFileTransfer",
        "responsibilities": [
          "Use Copy-VMFile for host-to-guest transfers",
          "Handle EnableGuestService requirement",
          "Manage directory recursion for uploads/downloads",
          "Validate file paths before transfer"
        ]
      },
      {
        "name": "PowerShellExecutor",
        "responsibilities": [
          "Execute PowerShell scripts with proper runspace",
          "Handle credential passing for remote execution",
          "Capture stdout/stderr streams",
          "Implement timeout handling",
          "Log errors with line numbers"
        ]
      },
      {
        "name": "VirtualBoxProvider",
        "responsibilities": [
          "Execute VBoxManage commands",
          "Parse machine-readable VM info output",
          "Manage Guest Additions availability",
          "Handle VBoxManage exit codes",
          "Translate VBox errors into domain exceptions"
        ]
      },
      {
        "name": "VirtualBoxFileTransfer",
        "responsibilities": [
          "Use VBoxManage guestcontrol copyto/copyfrom",
          "Handle Guest Additions installation check",
          "Manage directory permissions in guest",
          "Implement fallback to shared folders if available"
        ]
      },
      {
        "name": "FluentFtpClient",
        "responsibilities": [
          "Wrap FluentFTP library for FTP/FTPS",
          "Handle connection lifecycle",
          "Implement retry logic with exponential backoff",
          "Validate transfers via checksum",
          "Support active/passive mode"
        ]
      },
      {
        "name": "SshNetFtpClient",
        "responsibilities": [
          "Wrap SSH.NET for SFTP operations",
          "Support password and key-based auth",
          "Handle host key verification",
          "Implement connection pooling",
          "Support proxy connections"
        ]
      },
      {
        "name": "VMProviderFactory",
        "responsibilities": [
          "Create appropriate IVMProvider based on type",
          "Create matching IVMFileTransfer implementation",
          "Cache provider instances for reuse",
          "Validate provider prerequisites"
        ]
      },
      {
        "name": "VMDeploymentService",
        "responsibilities": [
          "Orchestrate full deployment workflow",
          "Coordinate provider, file transfer, and FTP clients",
          "Handle deployment failures and rollback",
          "Log deployment events to EV3NT collection",
          "Track deployment metrics and timing"
        ]
      },
      {
        "name": "VMDeploymentQueue",
        "responsibilities": [
          "Queue multiple deployment requests",
          "Execute deployments with configurable parallelism",
          "Track deployment progress",
          "Handle partial failures in batch operations",
          "Provide deployment status reporting"
        ]
      },
      {
        "name": "VMHealthMonitor",
        "responsibilities": [
          "Poll VM status at configured intervals",
          "Detect status changes and raise events",
          "Check VM responsiveness (heartbeat)",
          "Monitor resource usage if available",
          "Alert on health degradation"
        ]
      }
    ],
    "dependencies": [
      "NuGet: FluentFTP (>= 50.0.0) - Modern .NET FTP client",
      "NuGet: SSH.NET (>= 2024.0.0) - SFTP and SSH client",
      "NuGet: System.Management.Automation (>= 7.4.0) - PowerShell SDK (optional, for in-process execution)",
      "System: System.Diagnostics.Process - For PowerShell/VBoxManage CLI execution",
      "External: Hyper-V PowerShell Module (Windows Pro/Enterprise)",
      "External: VBoxManage CLI (VirtualBox installation required for fallback)",
      "External: PowerShell 5.1 or 7.x (for Hyper-V commands)",
      "Optional: Microsoft.Extensions.DependencyInjection.Abstractions (for DI registration)",
      "Optional: Microsoft.Extensions.Configuration.Abstractions (for config binding)",
      "Optional: Microsoft.Extensions.Logging.Abstractions (for structured logging)"
    ]
  }
}
